# Security & Encryption

Happy Coder uses end-to-end encryption. Your code stays private, even from us.

## The Short Version

1. **Your code is encrypted** before leaving your device
2. **Only you have the keys** - master secret never leaves your phone
3. **The relay server can't read anything** - it only sees encrypted blobs
4. **Open source** - audit the code yourself

## Encryption Architecture

The following diagrams explain how Happy Coder's encryption works in detail.

### Legend and Key Types

```txt
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         HAPPY CODER ENCRYPTION MODEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                  LEGEND                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  KEY TYPES                                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                   â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•—  Secret key     - Must be protected, enables decryption          â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•                                                                  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  Public key     - Safe to share, only enables encryption         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”„â”„â”„â”„â”„â”„â”„â”„â”  Ephemeral key  - Temporary, discarded after use                 â”‚
â”‚  â””â”„â”„â”„â”„â”„â”„â”„â”„â”˜                                                                  â”‚
â”‚                                                                              â”‚
â”‚  Â«â”€â”€â”€â”€â”€â”€â”€â”€Â»  Data Encryption Key (DEK) - Symmetric, encrypts actual content  â”‚
â”‚                                                                              â”‚
â”‚  ARROWS                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€>  Key/data movement                                                 â”‚
â”‚  â”„â”„â”„â”„â”„â”„â”„>  Encrypted data                                                    â”‚
â”‚                                                                              â”‚
â”‚  LIFECYCLE                                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                   â”‚
â”‚  [ONCE/ACCOUNT]   Created once per account, lives forever                    â”‚
â”‚  [ONCE/MACHINE]   Created once per CLI machine                               â”‚
â”‚  [ONCE/SESSION]   Created once per coding session                            â”‚
â”‚  [ONCE/AUTH]      Created for each QR auth, discarded immediately            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Hierarchy

```txt
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              KEY HIERARCHY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


                              LAYER 1: ROOT
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘  MASTER SECRET  (32 bytes)                                    [MOBILE]    â•‘
  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
  â•‘                                                                           â•‘
  â•‘  Lifecycle:    [ONCE/ACCOUNT] - created at signup                         â•‘
  â•‘  Stored:       Mobile secure storage only                                 â•‘
  â•‘  Backup:       XXXXX-XXXXX-XXXXX-... (base32)                             â•‘
  â•‘                                                                           â•‘
  â•‘  âŒ Never leaves device   âŒ Never sent anywhere                           â•‘
  â•‘                                                                           â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                      â”‚
                                      â”‚ HKDF derive
                                      â–¼

                         LAYER 2: CONTENT KEY PAIR
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â•‘  CONTENT SECRET KEY                  â•‘    â”‚  CONTENT PUBLIC KEY            â”‚
  â•‘  (32 bytes)                [MOBILE]  â•‘    â”‚  (32 bytes)        [MOBILE+CLI]â”‚
  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â•‘                                      â•‘    â”‚                                â”‚
  â•‘  Lifecycle: [ONCE/ACCOUNT]           â•‘    â”‚  Lifecycle: [ONCE/ACCOUNT]     â”‚
  â•‘             derived from master      â•‘    â”‚             derived from secretâ”‚
  â•‘                                      â•‘    â”‚                                â”‚
  â•‘  Purpose:                            â•‘    â”‚  Purpose:                      â”‚
  â•‘  â€¢ Decrypt DEKs from server          â•‘    â”‚  â€¢ Encrypt DEKs for storage    â”‚
  â•‘  â€¢ Sign messages to CLI              â•‘    â”‚  â€¢ Sent to CLI during auth     â”‚
  â•‘                                      â•‘    â”‚                                â”‚
  â•‘  âŒ Never leaves mobile               â•‘    â”‚  âœ“ Shared with all CLIs        â”‚
  â•‘                                      â•‘    â”‚                                â”‚
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                               â”‚
            â”‚ decrypts                                      â”‚ encrypts
            â–¼                                               â–¼

                    LAYER 3: DATA ENCRYPTION KEYS (DEKs)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  Â«â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•Â»  Â«â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•Â»
  â•‘  SESSION DEK                  â•‘  â•‘  MACHINE DEK                  â•‘
  â•‘  (32 bytes, random AES-256)   â•‘  â•‘  (32 bytes, random AES-256)   â•‘
  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
  â•‘                               â•‘  â•‘                               â•‘
  â•‘  Lifecycle: [ONCE/SESSION]    â•‘  â•‘  Lifecycle: [ONCE/MACHINE]    â•‘
  â•‘             random per sessionâ•‘  â•‘             random per CLI    â•‘
  â•‘                               â•‘  â•‘                               â•‘
  â•‘  Stored: Server (encrypted    â•‘  â•‘  Stored: Server (encrypted    â•‘
  â•‘          with content pubkey) â•‘  â•‘          with content pubkey) â•‘
  â•‘                               â•‘  â•‘                               â•‘
  â•‘  Purpose:                     â•‘  â•‘  Purpose:                     â•‘
  â•‘  â€¢ Encrypt session messages   â•‘  â•‘  â€¢ Encrypt machine metadata   â•‘
  â•‘  â€¢ Encrypt session metadata   â•‘  â•‘  â€¢ Encrypt machine state      â•‘
  â•‘                               â•‘  â•‘                               â•‘
  â•‘  ğŸ”‘ Enables future sharing:   â•‘  â•‘                               â•‘
  â•‘     Re-encrypt DEK for        â•‘  â•‘                               â•‘
  â•‘     friend's public key       â•‘  â•‘                               â•‘
  â•‘                               â•‘  â•‘                               â•‘
  Â«â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•Â»  Â«â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•Â»
            â”‚                                    â”‚
            â”‚ encrypts                           â”‚ encrypts
            â–¼                                    â–¼

                         LAYER 4: ACTUAL CONTENT
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  â”Œâ”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”  â”Œâ”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”
  â”†  Session Content (encrypted)  â”†  â”†  Machine Data (encrypted)     â”†
  â”†  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”†  â”†  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”†
  â”†  â€¢ Claude messages            â”†  â”†  â€¢ Machine name, status       â”†
  â”†  â€¢ Tool calls & results       â”†  â”†  â€¢ Active session info        â”†
  â”†  â€¢ File contents              â”†  â”†  â€¢ Machine preferences        â”†
  â”†  â€¢ Terminal output            â”†  â”†                               â”†
  â”†  â€¢ Session metadata           â”†  â”†                               â”†
  â”†                               â”†  â”†                               â”†
  â”†  Stored on server, encrypted  â”†  â”†  Stored on server, encrypted  â”†
  â”†  with session DEK             â”†  â”†  with machine DEK             â”†
  â””â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”˜  â””â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”˜
```

### Key State After Authentication

```txt
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                      KEY STATE AFTER AUTHENTICATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

     MOBILE                            SERVER                         CLI
        â”‚                                 â”‚                             â”‚
        â”‚                                 â”‚                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               â”‚  â”‚                     â”‚  â”‚                               â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚  â”‚  Encrypted storage  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â•‘  master_secret          â•‘  â”‚  â”‚  only:              â”‚  â”‚  â”‚  content_public_key   â”‚    â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚  â”‚                     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚             â”‚                 â”‚  â”‚  â€¢ Session DEKs     â”‚  â”‚                               â”‚
â”‚       derives                 â”‚  â”‚    (encrypted)      â”‚  â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚             â–¼                 â”‚  â”‚                     â”‚  â”‚  â•‘  machine_key (local)    â•‘  â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚  â”‚  â€¢ Machine DEKs     â”‚  â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚  â•‘  content_secret_key     â•‘  â”‚  â”‚    (encrypted)      â”‚  â”‚                               â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚  â”‚                     â”‚  â”‚  Â«â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•Â»  â”‚
â”‚             â”‚                 â”‚  â”‚  â€¢ Session content  â”‚  â”‚  â•‘  session DEKs           â•‘  â”‚
â”‚       decrypts                â”‚  â”‚    (encrypted)      â”‚  â”‚  â•‘  (decrypted in memory)  â•‘  â”‚
â”‚             â–¼                 â”‚  â”‚                     â”‚  â”‚  Â«â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•Â»  â”‚
â”‚  Â«â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•Â»  â”‚  â”‚  â€¢ Machine data     â”‚  â”‚                               â”‚
â”‚  â•‘  All DEKs (decrypted)   â•‘  â”‚  â”‚    (encrypted)      â”‚  â”‚  âŒ No master_secret          â”‚
â”‚  Â«â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•Â»  â”‚  â”‚                     â”‚  â”‚  âŒ No content_secret_key     â”‚
â”‚                               â”‚  â”‚  Cannot decrypt     â”‚  â”‚  âŒ Cannot decrypt other      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  anything           â”‚  â”‚     sessions' DEKs           â”‚
â”‚  â”‚  content_public_key     â”‚  â”‚  â”‚                     â”‚  â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚                     â”‚  â”‚                               â”‚
â”‚                               â”‚  â”‚                     â”‚  â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Session Sync Flow

```txt
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                           SESSION SYNC FLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

     MOBILE                            SERVER                         CLI
        â”‚                                 â”‚                             â”‚
        â”‚                                 â”‚      New session created    â”‚
        â”‚                                 â”‚              â”‚              â”‚
        â”‚                                 â”‚              â–¼              â”‚
        â”‚                                 â”‚  Â«â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•Â»
        â”‚                                 â”‚  â•‘ Generate random SESSION DEK   â•‘
        â”‚                                 â”‚  â•‘ (AES-256, 32 bytes)           â•‘
        â”‚                                 â”‚  Â«â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•Â»
        â”‚                                 â”‚              â”‚              â”‚
        â”‚                                 â”‚              â–¼              â”‚
        â”‚                                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                 â”‚  â”‚ Encrypt DEK with               â”‚
        â”‚                                 â”‚  â”‚ content_public_key             â”‚
        â”‚                                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                 â”‚              â”‚              â”‚
        â”‚                                 â”‚              â–¼              â”‚
        â”‚                                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                 â”‚  â”‚ Encrypt session content with   â”‚
        â”‚                                 â”‚  â”‚ SESSION DEK (AES-256)          â”‚
        â”‚                                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                 â”‚              â”‚              â”‚
        â”‚                                 â”‚â—„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”¼â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”‚
        â”‚                                 â”‚  encrypted   â”‚              â”‚
        â”‚                                 â”‚  DEK +       â”‚              â”‚
        â”‚                                 â”‚  encrypted   â”‚              â”‚
        â”‚                                 â”‚  content     â”‚              â”‚
        â”‚                                 â”‚              â”‚              â”‚
        â”‚â—„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”‚              â”‚              â”‚
        â”‚                                 â”‚              â”‚              â”‚
        â–¼                                 â”‚              â”‚              â”‚
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—      â”‚              â”‚              â”‚
  â•‘ 1. Decrypt DEK with            â•‘      â”‚              â”‚              â”‚
  â•‘    content_secret_key          â•‘      â”‚              â”‚              â”‚
  â•‘                                â•‘      â”‚              â”‚              â”‚
  â•‘ 2. Decrypt content with DEK    â•‘      â”‚              â”‚              â”‚
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•      â”‚              â”‚              â”‚
        â”‚                                 â”‚              â”‚              â”‚
        â–¼                                 â”‚              â”‚              â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚              â”‚              â”‚
  â”‚ Display session  â”‚                    â”‚              â”‚              â”‚
  â”‚ in mobile app    â”‚                    â”‚              â”‚              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚              â”‚              â”‚
        â”‚                                 â”‚              â”‚              â”‚
        â”‚   User sends command            â”‚              â”‚              â”‚
        â”‚              â”‚                  â”‚              â”‚              â”‚
        â–¼              â”‚                  â”‚              â”‚              â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚              â”‚              â”‚
  â”‚ Encrypt with SESSION DEK        â”‚     â”‚              â”‚              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚              â”‚              â”‚
        â”‚                                 â”‚              â”‚              â”‚
        â”‚â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„>â”‚              â”‚              â”‚
        â”‚                                 â”‚â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„>â”‚              â”‚
        â”‚                                 â”‚              â–¼              â”‚
        â”‚                                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                 â”‚  â”‚ Decrypt with SESSION DEK       â”‚
        â”‚                                 â”‚  â”‚ (CLI has DEK in memory)        â”‚
        â”‚                                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                 â”‚              â”‚              â”‚
        â–¼                                 â–¼              â–¼              â–¼
```

### Future: Sharing With Friends

```txt
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    FUTURE: SHARING WITH FRIENDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

To share a session with a friend:

  YOUR MOBILE                         SERVER                    FRIEND'S MOBILE
       â”‚                                 â”‚                             â”‚
       â”‚                                 â”‚                             â”‚
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—         â”‚                             â”‚
  â•‘ 1. Get friend's            â•‘         â”‚                             â”‚
  â•‘    content_public_key      â•‘â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â•‘                            â•‘         â”‚  (friend's public key       â”‚
  â•‘ 2. Decrypt session DEK     â•‘         â”‚   is on their profile)      â”‚
  â•‘    with YOUR secret key    â•‘         â”‚                             â”‚
  â•‘                            â•‘         â”‚                             â”‚
  â•‘ 3. Re-encrypt session DEK  â•‘         â”‚                             â”‚
  â•‘    with FRIEND's pub key   â•‘         â”‚                             â”‚
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚                             â”‚
       â”‚                                 â”‚                             â”‚
       â”‚â”„â”„â”„â”„ share record â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„>â”‚                             â”‚
       â”‚     (DEK encrypted for friend)  â”‚                             â”‚
       â”‚                                 â”‚                             â”‚
       â”‚                                 â”‚â”„â”„â”„â”„ share notification â”„â”„â”„â”„>â”‚
       â”‚                                 â”‚                             â”‚
       â”‚                                 â”‚    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
       â”‚                                 â”‚    â•‘ Friend decrypts DEK with      â•‘
       â”‚                                 â”‚    â•‘ THEIR content_secret_key      â•‘
       â”‚                                 â”‚    â•‘                               â•‘
       â”‚                                 â”‚    â•‘ Friend can now decrypt        â•‘
       â”‚                                 â”‚    â•‘ session content with DEK      â•‘
       â”‚                                 â”‚    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â”‚                                 â”‚                             â”‚
       â–¼                                 â–¼                             â–¼

  KEY INSIGHT: Session content never re-encrypted!
  Only the small DEK (32 bytes) is re-encrypted for friend.
  Original encrypted content stays exactly the same on server.
```

### Key Purpose Summary

```txt
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            KEY PURPOSE SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KEY                 â”‚  LIFECYCLE    â”‚  PURPOSE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      â”‚               â”‚                                       â”‚
â”‚  MASTER SECRET       â”‚ ONCE/ACCOUNT  â”‚  Root key, derives everything         â”‚
â”‚                      â”‚               â”‚  Backup code = this in base32         â”‚
â”‚                      â”‚               â”‚                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      â”‚               â”‚                                       â”‚
â”‚  CONTENT KEY PAIR    â”‚ ONCE/ACCOUNT  â”‚  Encrypt/decrypt DEKs                 â”‚
â”‚  (public + secret)   â”‚               â”‚  Enable sharing without re-encrypting â”‚
â”‚                      â”‚               â”‚  content                              â”‚
â”‚                      â”‚               â”‚                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      â”‚               â”‚                                       â”‚
â”‚  SESSION DEK         â”‚ ONCE/SESSION  â”‚  Encrypt session messages & metadata  â”‚
â”‚  (AES-256)           â”‚               â”‚  Shareable: re-encrypt for friends    â”‚
â”‚                      â”‚               â”‚                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      â”‚               â”‚                                       â”‚
â”‚  MACHINE DEK         â”‚ ONCE/MACHINE  â”‚  Encrypt machine-specific data        â”‚
â”‚  (AES-256)           â”‚               â”‚  Revocable per-machine                â”‚
â”‚                      â”‚               â”‚                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      â”‚               â”‚                                       â”‚
â”‚  MACHINE KEY (local) â”‚ ONCE/MACHINE  â”‚  Local CLI cache encryption           â”‚
â”‚                      â”‚               â”‚  Never sent anywhere                  â”‚
â”‚                      â”‚               â”‚                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      â”‚               â”‚                                       â”‚
â”‚  EPHEMERAL KEYPAIR   â”‚ ONCE/AUTH     â”‚  Secure key exchange during QR auth   â”‚
â”‚                      â”‚               â”‚  Discarded immediately after          â”‚
â”‚                      â”‚               â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Security Properties

```txt
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            SECURITY PROPERTIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  COMPROMISE SCENARIO             ATTACKER GAINS              CANNOT ACCESS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  CLI machine compromised         â€¢ content_public_key        â€¢ master_secret
                                  â€¢ machine_key (local)       â€¢ content_secret_key
                                  â€¢ session DEKs (in memory)  â€¢ OTHER sessions' DEKs
                                  â€¢ THIS machine's sessions   â€¢ friends' sessions

  Server compromised              â€¢ encrypted DEKs            â€¢ decrypted DEKs
                                  â€¢ encrypted content         â€¢ any content
                                  â€¢ metadata                  â€¢ keys

  Network eavesdropping           â€¢ encrypted traffic         â€¢ anything useful

  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  RECOVERY SCENARIO               SOLUTION
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  CLI machine lost/stolen         Remove from account - session DEKs were only
                                  in memory, machine DEK is revoked

  Mobile lost + have backup       Restore master_secret â†’ re-derive content keys
                                  â†’ can decrypt all DEKs again

  Mobile lost + no backup         Account unrecoverable (by design)
```

## Why This Design?

**Your master secret never leaves your mobile device.** Each CLI machine receives only a derived public key for encryption. This means:

- If a CLI machine is compromised, the attacker cannot access your backup code or other machines
- The server only stores encrypted blobs it cannot read
- Sharing sessions with friends is efficient - only re-encrypt a 32-byte key, not all the content

## Self-Hosting

Don't trust our relay server? Run your own. See our [Self-Hosting Guide](/docs/guides/self-hosting) for details.
